<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Django高级使用：三 |  瑟兰迪尔
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Django高级使用：三"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Django高级使用：三
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2022/12/07/Django%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%EF%BC%9A%E4%B8%89/" class="article-date">
  <time datetime="2022-12-07T02:08:52.000Z" itemprop="datePublished">2022-12-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">9.2k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">38 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Django高级使用：三"><a href="#Django高级使用：三" class="headerlink" title="Django高级使用：三"></a>Django高级使用：三</h1><h2 id="一-Django日志管理"><a href="#一-Django日志管理" class="headerlink" title="一. Django日志管理"></a>一. Django日志管理</h2><blockquote>
<p>前言：当Django项目部署上线之后，我们很难像开发时那样容易的及时发现错误和异常。那么项目上线后开发者应该怎样检查Django程序在生产环境运行时有什么异常和错误？使用日志(log)，这部分内容将重点介绍如何在Django项目中正确配置或管理日志</p>
</blockquote>
<h3 id="1-日志基础"><a href="#1-日志基础" class="headerlink" title="1.日志基础"></a>1.日志基础</h3><blockquote>
<p>日志与我们的软件程序密不可分，它记录了程序的运行情况。可以给我们调试程序和排查故障提供非常有用的信息。每一条日志信息记录了一个事件的发生。具体而言，它包括了：</p>
</blockquote>
<ul>
<li>事件发生时间</li>
<li>事件发生位置</li>
<li>事件的严重程度-日志级别</li>
<li>事件内容<br>日志的级别又分为：</li>
<li>DEBUG: 用于调试目的的低级系统信息</li>
<li>INFO：一般系统信息</li>
<li>WARNING：描述已发生的小问题的警告信息</li>
<li>ERROR：描述已发生的主要问题的错误信息</li>
<li>CRITICAL：描述已发生的严重问题的信息<br>在Django项目中，我们可以针对日志的不同级别设置不同的处理方式。比如INFO级别及以上的日志我们写入到log文件里保存，ERROR级别及以上的日志我们直接通过邮件发送给系统管理员。<h3 id="2-Django的日志模块"><a href="#2-Django的日志模块" class="headerlink" title="2.Django的日志模块"></a>2.Django的日志模块</h3>Django的日志模块其实就是python的<code>logging</code>模块，它由4部分组成：</li>
<li>Logger记录仪：生成和记录每条日志信息及级别</li>
<li>Handler处理程序：根据日志信息级别交由相应处理程序处理(比如生成文件或发送邮件)</li>
<li>Filters过滤器：日志交由处理程序处理前需要满足的过滤条件(比如Debug=True或False)</li>
<li>Formaters格式化程序：决定每条日志的打印输出格式，可以有完整版的，也有简单版的</li>
</ul>
<p>一个<code>logger</code>记录仪的例子如下所示。当程序运行出现错误时，它生成了一条级别为error的日志信息。这条记录产生后就会交由<code>Handler</code>处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import logging</span><br><span class="line"># 获得logger实例</span><br><span class="line">logger &#x3D; logging.getLogger(__name__)</span><br><span class="line">def my_view(request, arg1, arg2):</span><br><span class="line">    ...</span><br><span class="line">    if error_happens:</span><br><span class="line">        # 如发生错误，则记录错误信息</span><br><span class="line">        logger.error(&#39;Something went wrong&#39;)</span><br></pre></td></tr></table></figure>
<p>当<code>Debug=True</code>时，日志默认从<code>console</code>输出。现在我们还需要在django配置文件里配置日志(logging)相关内容，使得当<code>Debug=False</code>时，日志信息会输出到日志文件里或发送给系统管理员。</p>
<h3 id="3-settings-py推荐日志配置"><a href="#3-settings-py推荐日志配置" class="headerlink" title="3.settings.py推荐日志配置"></a>3.settings.py推荐日志配置</h3><p>以下基本配置信息在django cookiecutter推荐使用的logging配置信息上做了修改，可适合大部分项目使用。如果真的希望发送和接收邮件还需在<code>settings.py</code>正确配置电子邮箱Email</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 给ADMINS发送邮件需配置</span><br><span class="line">ADMINS &#x3D; (</span><br><span class="line"> (&#39;admin_name&#39;, &#39;your@gmail.com&#39;)</span><br><span class="line">)</span><br><span class="line">MANAGERS &#x3D; ADMINS</span><br><span class="line"></span><br><span class="line"># 创建log文件的文件夹</span><br><span class="line">LOG_DIR &#x3D; os.path.join(BASE_DIR, &quot;logs&quot;)</span><br><span class="line">if not os.path.exists(LOG_DIR):</span><br><span class="line">    os.mkdir(LOG_DIR)</span><br><span class="line">    </span><br><span class="line"># 基本配置，可以复用的</span><br><span class="line">LOGGING &#x3D; &#123;</span><br><span class="line">    &quot;version&quot;: 1,</span><br><span class="line">    &quot;disable_existing_loggers&quot;: False # 禁用已经存在的logger实例</span><br><span class="line">    &quot;filters&quot;:&#123;&quot;require_debug_false&quot;: &#123;&quot;()&quot;: &quot;django.utils.log.RequireDebugFalse&quot;&#125;&#125;,</span><br><span class="line">    &quot;formatters&quot;:&#123; # 定义了两种日志格式</span><br><span class="line">        &quot;verbose&quot;:&#123;</span><br><span class="line">            # 详细</span><br><span class="line">            &quot;format&quot;: &quot;%(levelname)s %(asctime)s %(module)s&quot;</span><br><span class="line">            &quot;%(process)d %(thread)d %(message)s&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;simple&quot;:&#123;</span><br><span class="line">            # 简单</span><br><span class="line">            &#39;format&#39;: &#39;[%(levelname)s][%(asctime)s][%(filename)s:%(lineno)d]%(message)s&#39;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;handlers&quot;:&#123;</span><br><span class="line">        # 定义了三种日志处理方式</span><br><span class="line">        &quot;mail_admins&quot;:&#123;</span><br><span class="line">            # 只有debug&#x3D;False且Error级别以上发邮件给admin</span><br><span class="line">            &quot;level&quot;: &quot;Error&quot;,</span><br><span class="line">            &quot;filters&quot;: [&quot;require_debug_false&quot;],</span><br><span class="line">            &quot;class&quot;: &quot;django.utils.log.AdminEmailHandler&quot;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#39;file&#39;:&#123;</span><br><span class="line">            # 对INFO级别以上信息以日志文件形式保存</span><br><span class="line">            &#39;level&#39;: &quot;INFO&quot;,</span><br><span class="line">            &#39;class&#39;: &#39;logging.handlers.RotatingFileHandler&#39;, #滚动生成日志，切割</span><br><span class="line">            &#39;filename&#39;: os.path.join(LOG_DIR, &#39;django.log&#39;),</span><br><span class="line">            &#39;maxBytes&#39;: 1024*1024*10 #单个日志最大为10M</span><br><span class="line">            &#39;backupCount&#39;:5, # 日志备份文件最大数量</span><br><span class="line">            &#39;formatter&#39;:&#39;simple&#39;, # 简单格式</span><br><span class="line">            &#39;encoding&#39;: &#39;utf-8&#39; # 放置中文乱码</span><br><span class="line">        &#125;，</span><br><span class="line">        &quot;console&quot;：&#123;</span><br><span class="line">            # 打印到终端console</span><br><span class="line">            &quot;level&quot;: &quot;DEBUG&quot;,</span><br><span class="line">            &quot;class&quot;: &quot;logging.StreamHandler&quot;,</span><br><span class="line">            &quot;formatter&quot;: &quot;verbose&quot;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;root&quot;:&#123;&quot;level&quot;:&quot;INFO&quot;, &quot;handlers&quot;:[&quot;console&quot;]&#125;,</span><br><span class="line">    &quot;loggers&quot;:&#123;</span><br><span class="line">        &quot;django.request&quot;:&#123;</span><br><span class="line">            # Django的request发生error会自动记录</span><br><span class="line">            &quot;handlers&quot;: [&quot;mail_admins&quot;],</span><br><span class="line">            &quot;level&quot;:&quot;ERROR&quot;,</span><br><span class="line">            &quot;propagate&quot;: True, # 向不向更高级别的logger传递</span><br><span class="line">        &#125;，</span><br><span class="line">        &quot;django.security.DisallowedHost&quot;:&#123;</span><br><span class="line">            # 对于不在ALLOWED_HOSTS中的请求不发送报错邮件</span><br><span class="line">            &quot;level&quot;: &quot;ERROR&quot;,</span><br><span class="line">            &quot;handlers&quot;: [&quot;console, &quot;mail_admins&quot;],</span><br><span class="line">            &quot;propagate&quot;: True,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上配置中需要我们特别关注的是Python提供的<code>RotatingFileHandler</code>，其作用是滚动生成日志文件，当单个日志文件的大小达到上限时，会生成新的日志文件。当总的日志文件数量超过日志备份最大数量时删除老的日志文件。</p>
<h3 id="4-其他日志管理工具"><a href="#4-其他日志管理工具" class="headerlink" title="4.其他日志管理工具"></a>4.其他日志管理工具</h3><p>在前面日志配置中，我们使用了Django自带的<code>logging</code>模块，另外两个常用的日志管理工具是<code>loguru</code>和<code>sentry</code>。我们将简单演示如何使用</p>
<h4 id="4-1-loguru"><a href="#4-1-loguru" class="headerlink" title="4.1 loguru"></a>4.1 loguru</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install loguru</span><br></pre></td></tr></table></figure>
<p>安装好后在Django项目中可以直接在视图中使用。省去复杂的配置，非常便捷。它定义了日志文件名、每条记录的格式、日志文件的轮替以及过滤级别。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from loguru import logger</span><br><span class="line"></span><br><span class="line">logger.add(&quot;django.log&quot;, format&#x3D;&quot;&#123;time:YYYY-MM-DD at HH:mm:ss&#125; | &#123;level&#125; | &#123;message&#125;&quot;, rotation&#x3D;&quot;100MB&quot;, filter&#x3D;&quot;&quot;, level&#x3D;&quot;INFO&quot;, encoding&#x3D;&#39;utf-8&#39;)</span><br><span class="line">def my_view(request, arg1, arg2):</span><br><span class="line">    ...</span><br><span class="line">    if error_happens:</span><br><span class="line">        logger.error(&quot;Something went wrong&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="4-2-sentry"><a href="#4-2-sentry" class="headerlink" title="4.2 sentry"></a>4.2 sentry</h4><p>Sentry为多种语言以及各种框架(包括Django)提供了SDK。只需几行配置，sentry就会监控你的程序运行，自动收集错误以及上下文数据，发送到sentry服务器上，开发者可以通过sentry的web端实时查看错误和异常。</p>
<h2 id="二-Django国际化"><a href="#二-Django国际化" class="headerlink" title="二. Django国际化"></a>二. Django国际化</h2><p>&emsp;&emsp;很多时候我们的读者或客户遍布全球，这时候就需要对网站或APP进行国际化，让其支持多种语言。虽然Django的功能强大，但真正实现国际化，让网站根据用户的语言喜好来显示不同的内容并不是一件容易的事。本文将以一个最简单的例子，教你如何设置让Django支持多语种网站。</br><br>&emsp;&emsp;关于Django的国际化我们需要知道：我们实现了中英对照翻译，但这个翻译不是浏览器翻译的，Django也不会帮你翻译。这个需要你自己事先手动翻译好，存放在专门的翻译文件中，Django只是事后调用而已。</p>
<h3 id="1-修改settings-py配置"><a href="#1-修改settings-py配置" class="headerlink" title="1.修改settings.py配置"></a>1.修改settings.py配置</h3><p>假设我们已经创建了一个<code>mypoject</code>的项目，那么为了支持国际化/多语种，首先应该做如下两件事：</p>
<ul>
<li>在myproject目录下新建<code>locale</code>文件夹，用于保存翻译消息文件(.po和.mo格式的)</li>
<li>修改配置文件<code>settings.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line">from django.utils.translation import ugettext_lazy as _</span><br><span class="line"></span><br><span class="line"># 默认语言</span><br><span class="line">LANGUAGE_CODE &#x3D; &#39;en-us&#39;</span><br><span class="line"></span><br><span class="line"># 设置I18n和L10N为True</span><br><span class="line">USE_I18N &#x3D; True</span><br><span class="line">USE_L10N &#x3D; True</span><br><span class="line"></span><br><span class="line"># 支持指定语言，这里为了简化只支持简体中文和英文</span><br><span class="line">LANGUAGES &#x3D; (</span><br><span class="line">    (&#39;en&#39;, _(&#39;English&#39;)),</span><br><span class="line">    (&#39;zh-hans&#39;,_(&#39;Simplified Chinese&#39;))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 用于存放django.po和django.mo编译过的翻译文件</span><br><span class="line">PROJECT_ROOT &#x3D; os.path.dirname(os.path.realpath(__name__))</span><br><span class="line">LOCALE_PATHS &#x3D; (</span><br><span class="line">    os.path.join(PROJECT, &#39;locale&#39;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在这里我们使用了<code>ugettext_lazy</code>这个方法，它的作用是在.py文件中标记需要翻译的字符串，对其进行惰性参照存储，而不是对字符串进行真正的翻译。我们经常会在<code>models.py</code>中定义字段时用到它，也会在<code>views.py</code>中用到它，指定需要翻译的字符串。然而在模板html文件中我们并不能直接使用<code>ugettext_lazy</code>这个方法，而是使用<code>&#123;% trans "string" %&#125;, &#123;% blocktrans %&#125; &#123;% endblocktrans %&#125;这两个标签来标记需要翻译的字符串</code></br><br>&emsp;&emsp;注意：这两个标签也不是对字符串进行真正的翻译，只是标记而已。使用这两个模板标签前需要在模板的最开始地方加入<code>&#123;lload i18n %&#125;</code>。</br><br>&emsp;&emsp;最后别忘了加入<code>LocaleMiddleware</code>这个中间件，它的位置也很重要，应于<code>SessionMiddleware</code>之后，<code>CommonMiddleware</code>之前。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE &#x3D; [</span><br><span class="line">    &#39;django.middleware.security.SecurityMiddleware&#39;,</span><br><span class="line">    &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,</span><br><span class="line">    &#39;django.middleware.locale.LocaleMiddleware&#39;, # 新增多语支持</span><br><span class="line">    &#39;django.middleware.common.CommonMiddleware&#39;,</span><br><span class="line">    &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,</span><br><span class="line">    &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,</span><br><span class="line">    &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,</span><br><span class="line">    &#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>其中，i18n是国际化(Internationalization)的缩写， l10n是本地化(localization)的缩写。</p>
<h3 id="2-修改项目的urls-py"><a href="#2-修改项目的urls-py" class="headerlink" title="2.修改项目的urls.py"></a>2.修改项目的urls.py</h3><p>本步动作是为了增加对国际化i18n的支持，具体代码如下所示：<code>i18n_patterns</code>的作用是让每个url前面自动加上所选语言的代码，比如/en/,/zh-hans/等等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib import admin</span><br><span class="line">from django.urls import path, include</span><br><span class="line">from django.conf.urls.i18n import i18n_patterns</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    path(&#39;i18n&#x2F;&#39;, include(&#39;django.conf.urls.i18n&#39;)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns +&#x3D; i18n_patterns(</span><br><span class="line">    path(&#39;admin&#x2F;&#39;, admin.site.urls),</span><br><span class="line">    path(&#39;&#39;, include(&#39;myapp.urls&#39;)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="3-在-py-html和-txt文件中标记需要翻译的字符串"><a href="#3-在-py-html和-txt文件中标记需要翻译的字符串" class="headerlink" title="3.在.py, .html和.txt文件中标记需要翻译的字符串"></a>3.在.py, .html和.txt文件中标记需要翻译的字符串</h3><p>&emsp;&emsp;Django支持在python文件，html和txt文本文件中标记需要翻译的字符串。在python文件中使用<code>ugettext_lazy</code>方法或简写的<code>_</code>，在html和txt文件中使用<code>trans</code>和<code>blocktrans</code>标签，使用前还需要在文件开头加入<code>&#123;lload i18n %&#125;</code>。</br><br>&emsp;&emsp;例子中我们不需要使用模型，只需开发一个url，所以只需要一个视图(index)和模板(index.html).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># myapp&#x2F;urls.py</span><br><span class="line">from django.urls import path</span><br><span class="line">from . import views</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app_name &#x3D; &#39;myapp&#39;</span><br><span class="line">urlpatterns &#x3D; (</span><br><span class="line">    path(&#39;&#39;, views.index, name&#x3D;&#39;index&#39;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在视图中我们使用<code>ugettext_lazy</code>方法标记了一个需要翻译的字符串”Welcome to China”.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># myapp&#x2F;views.py</span><br><span class="line">from django.shortcuts import render</span><br><span class="line">from django.utils.translation import ugettext_lazy as _</span><br><span class="line"></span><br><span class="line"># Create your views here</span><br><span class="line">def index(request):</span><br><span class="line">    context &#x3D; &#123;&#39;msg&#39;: _(&quot;Welcome to China&quot;)&#125;</span><br><span class="line">    return render(request, &#39;myapp&#x2F;index.html&#39;, context)</span><br></pre></td></tr></table></figure>
<p>模板文件中最重要的一段代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block content %&#125;</span><br><span class="line">&lt;div class&#x3D;&quot;py-4 px-3 bg-light&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">    &#123;% get_current_language as LANGUAGE_CODE %&#125;</span><br><span class="line">        &lt;h4&gt;&#123;% trans &#39;Current language code&#39; %&#125;: &#123;&#123; LANGUAGE_CODE&#125;&#125;&lt;&#x2F;b&gt;&lt;&#x2F;h4&gt;</span><br><span class="line">        &lt;p&gt;&lt;small&gt;&#123;% trans &quot;Welcome to our page&quot; %&#125;&lt;&#x2F;small&gt;&lt;&#x2F;p&gt;</span><br><span class="line">        &lt;hr&#x2F;&gt;</span><br><span class="line">        &lt;p&gt;&#123;% blocktrans %&#125; &#123;&#123;msg&#125;&#125; &#123;% endblocktrans %&#125; &lt;&#x2F;p&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>{lload i18n %}以后，你可以使用<code>get_current_language</code>标签获得当前语言，我们还在模板中分别使用<code>&#123;% trans 'string' %&#125;</code>和<code>&#123;% blocktrans&#125; &#123;%endblocktrans&#125;</code>标签来标记了两个需要翻译的字符串，一个是模板中已经存在的字符串，一个是视图函数转递过来的变量。</p>
<h3 id="4-生成-po和-mo编译消息文件"><a href="#4-生成-po和-mo编译消息文件" class="headerlink" title="4.生成.po和.mo编译消息文件"></a>4.生成.po和.mo编译消息文件</h3><p>最后一步，我们需要对前面标记的字符串进行手动翻译，并生成编译过后的消息文件供Django使用。新手最容易犯的错误就是以为<code>trans</code>标签能实现自动翻译。整个过程一共有3步，请各位仔细阅读：</p>
<h4 id="4-1-提取所有需要翻译的字符串"><a href="#4-1-提取所有需要翻译的字符串" class="headerlink" title="4.1 提取所有需要翻译的字符串"></a>4.1 提取所有需要翻译的字符串</h4><p>进入项目文件夹，使用<code>django-admin makemessages -l zh_HANS</code>命令提取所有前面标记需要翻译的字符串，该命令会自动生成一个名为<code>django.po</code>的文件，地址如下所示</p>
<h4 id="4-2-修改django-po文件，添加手动翻译的字符串"><a href="#4-2-修改django-po文件，添加手动翻译的字符串" class="headerlink" title="4.2 修改django.po文件，添加手动翻译的字符串"></a>4.2 修改<code>django.po</code>文件，添加手动翻译的字符串</h4><h4 id="4-3生成翻译编译文件"><a href="#4-3生成翻译编译文件" class="headerlink" title="4.3生成翻译编译文件"></a>4.3生成翻译编译文件</h4><p>运行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py compilemessages</span><br></pre></td></tr></table></figure>
<p>该命令会生成一个<code>django.mo</code>的文件，内容如下所示：这个就是Django最后需要调用的翻译文件，里面包含了翻译过后的字符串列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Report-Msgid-Bugs-To: </span><br><span class="line">PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE</span><br><span class="line">Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;</span><br><span class="line">Language-Team: LANGUAGE &lt;LL@li.org&gt;</span><br><span class="line">Language: </span><br><span class="line">MIME-Version: 1.0</span><br><span class="line">Content-Type: text&#x2F;plain; charset&#x3D;UTF-8</span><br><span class="line">Content-Transfer-Encoding: 8bit</span><br><span class="line">Plural-Forms: nplurals&#x3D;1; plural&#x3D;0;</span><br><span class="line"> 当前语言代码 英语 隐私与Cookie 选择 简体中文 服务条款与协议 欢迎来到中国 欢迎来到我们主页</span><br></pre></td></tr></table></figure>
<h2 id="三-Docker部署Django"><a href="#三-Docker部署Django" class="headerlink" title="三. Docker部署Django"></a>三. Docker部署Django</h2><p>Django在生产环境的部署还是比较复杂的，令很多新手望而生畏，幸运的是使用Docker容器化技术可以大大简化我们Django在生产环境的部署并提升我们应用的可移植性。Docker是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中，然后发布到任何流行的Linux机器上。本文将详细介绍如何使用docker-compose八步部署Django+Uwsgi+Nginx+MySQL+Redis</p>
<h3 id="1-Django-Uwsgi-Nginx-MySQL-Redis组合容器"><a href="#1-Django-Uwsgi-Nginx-MySQL-Redis组合容器" class="headerlink" title="1.Django+Uwsgi+Nginx+MySQL+Redis组合容器"></a>1.Django+Uwsgi+Nginx+MySQL+Redis组合容器</h3><ul>
<li>Django + Uwsgi容器：核心应用程序，处理动态请求</li>
<li>MySQL容器：数据库服务</li>
<li>Redis容器：缓存服务</li>
<li>Nginx容器：反向代理服务并处理静态资源请求</li>
</ul>
<p>这四个容器的依赖关系是：Django + Uwsgi容器依赖Redis容器和MySQL容器，Nginx容器依赖Django + Uwsgi容器。为了方便容器间的相互访问和通信，我们使用docker-compose时可以给每个容器取个别名，这样访问容器时就可以直接使用别名访问，而不使用Docker临时给容器分配的IP了</p>
<h3 id="2-Docker-compose部署Django项目布局树形图"><a href="#2-Docker-compose部署Django项目布局树形图" class="headerlink" title="2.Docker-compose部署Django项目布局树形图"></a>2.Docker-compose部署Django项目布局树形图</h3><p>我们新建了一个compose文件夹，专门存放用于构建其他容器镜像的Dockerfile及配置文件。compose文件夹与django项目的根目录myproject同级。这样做的好处是不同的django项目可以共享compose文件夹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">myproject_docker  # 项目根目录</span><br><span class="line">|——— compose # 存放各项容器服务的Dockerfile和配置文件</span><br><span class="line">│   ├── mysql</span><br><span class="line">│   │   ├── conf</span><br><span class="line">│   │   │   └── my.cnf # MySQL配置文件</span><br><span class="line">│   │   └── init</span><br><span class="line">│   │       └── init.sql # MySQL启动脚本</span><br><span class="line">│   ├── nginx</span><br><span class="line">│   │   ├── Dockerfile # 构建Nginx镜像所的Dockerfile</span><br><span class="line">│   │   ├── log # 挂载保存nginx容器内日志log目录</span><br><span class="line">│   │   ├── nginx.conf # Nginx配置文件</span><br><span class="line">│   │   └── ssl # 如果需要配置https需要用到</span><br><span class="line">│   ├── redis</span><br><span class="line">│   │   └── redis.conf # redis配置文件</span><br><span class="line">│   └── uwsgi # 挂载保存django+uwsgi容器内uwsgi日志</span><br><span class="line">├── docker-compose.yml # 核心编排文件</span><br><span class="line">└── myproject # 常规Django项目目录</span><br><span class="line">    ├── Dockerfile # 构建Django+Uwsgi镜像的Dockerfile</span><br><span class="line">    ├── apps # 存放Django项目的各个apps</span><br><span class="line">    ├── manage.py</span><br><span class="line">    ├── myproject # Django项目配置文件</span><br><span class="line">    │   ├── asgi.py</span><br><span class="line">    │   ├── __init__.py</span><br><span class="line">    │   ├── settings.py</span><br><span class="line">    │   ├── urls.py</span><br><span class="line">    │   └── wsgi.py</span><br><span class="line">    ├── pip.conf # 非必需。pypi源设置成国内，加速pip安装</span><br><span class="line">    ├── requirements.txt # Django项目依赖文件</span><br><span class="line">    ├── .env # 环境变量文件</span><br><span class="line">    ├── start.sh # 启动Django+Uwsgi容器后要执行的脚本</span><br><span class="line">    ├── media # 用户上传的媒体资源，如果没有需手动创建</span><br><span class="line">    ├── static #搜集项目的静态文件夹，如果没有需手动创建</span><br><span class="line">    └── uwsgi.ini # uwsgi配置文件</span><br></pre></td></tr></table></figure>
<h3 id="3-正式部署"><a href="#3-正式部署" class="headerlink" title="3.正式部署"></a>3.正式部署</h3><h4 id="3-1-编写docker-compose-yml文件"><a href="#3-1-编写docker-compose-yml文件" class="headerlink" title="3.1 编写docker-compose.yml文件"></a>3.1 编写docker-compose.yml文件</h4><p>修改过的docker-compose.yml的核心内容如下。我们定义了4个数据卷，用于挂载各个容器内动态生成的数据，比如MySQL的存储数据， redis生成的快照、django+uwsgi容器收集的静态文件以及用户上传的媒体资源。这样即使删除容器，容器内产生的数据也不会丢失。</br><br>我们还定义了三个网络，分别为<code>nginx_network</code>(用于nginx和web容器间的通信)，<code>db_network</code>(用于db和web容器间的通信)和<code>redis_network</code>(用于redis和web容器间的通信)。</br><br>整个编排里包含4项容器服务，别名分别为：<code>redis</code>、<code>db</code>、<code>nginx</code>和<code>web</code>，接下来我们将依次看看各个容器的Dockerfile和配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">volume: # 自定义数据卷</span><br><span class="line">  db_vol:# 定义数据卷同步存放容器内mysql数据</span><br><span class="line">  redis_vol: # 定义数据卷同步存放redis数据</span><br><span class="line">  media_vol: # 定义数据卷同步存放web项目用户上传到media文件夹的数据</span><br><span class="line">  static_vol: # 定义数据同步存放web项目static文件夹的数据</span><br><span class="line">  </span><br><span class="line">networks: # 自定义网络(默认桥接)，不使用links通信</span><br><span class="line">  nginx_network:</span><br><span class="line">    driver: bridge</span><br><span class="line">  db_network:</span><br><span class="line">    driver: bridge</span><br><span class="line">  redis_network:</span><br><span class="line">    driver: bridge</span><br><span class="line"></span><br><span class="line">serices:</span><br><span class="line">  redis:</span><br><span class="line">    image: redis:latest</span><br><span class="line">    command: redis-server &#x2F;etc&#x2F;redis&#x2F;redis.conf # 容器启动后启动redis服务</span><br><span class="line">    networks:</span><br><span class="line">      - redis_network</span><br><span class="line">    volums:</span><br><span class="line">      - redis_vol: &#x2F;data # 通过挂载给redis数据备份</span><br><span class="line">      - .&#x2F;compose&#x2F;redis&#x2F;redis.conf:&#x2F;etc&#x2F;redis&#x2F;redis.conf # 挂载redis配置文件</span><br><span class="line">    ports:</span><br><span class="line">      -&quot;6379:6379</span><br><span class="line">    restart: always # always表示容器运行发生错误时一直重启</span><br><span class="line"></span><br><span class="line">db:</span><br><span class="line">  image: mysql</span><br><span class="line">  env_file:</span><br><span class="line">    - .&#x2F;myproject&#x2F;.env # 使用了环境变量文件</span><br><span class="line">  networks:</span><br><span class="line">    -db_network</span><br><span class="line">  volumes:</span><br><span class="line">    -db_vol:&#x2F;var&#x2F;lib&#x2F;mysql # 挂载数据库数据，可读可写</span><br><span class="line">    - .&#x2F;compose&#x2F;mysql&#x2F;conf&#x2F;my.cnf:&#x2F;etc&#x2F;mysql&#x2F;my.cnf # 挂载配置文件</span><br><span class="line">    - .&#x2F;compose&#x2F;mysql&#x2F;init: &#x2F;docker-entrypoint-initdb.d&#x2F; # 挂载数据初始化sql脚本</span><br><span class="line">  ports:</span><br><span class="line">    - &quot;3306:3306&quot; # 与配置文件保持一致</span><br><span class="line">  restart:always</span><br><span class="line"> </span><br><span class="line">web:</span><br><span class="line">  build: .&#x2F;myproject</span><br><span class="line">  expose:</span><br><span class="line">    -&quot;8000&quot;</span><br><span class="line">  volums:</span><br><span class="line">    - .&#x2F;myproject:&#x2F;var&#x2F;www&#x2F;html&#x2F;myproject # 挂载项目代码</span><br><span class="line">    - static_vol:&#x2F;var&#x2F;www&#x2F;html&#x2F;myproject&#x2F;static # 以数据卷挂载容器内static文件</span><br><span class="line">    - media_vol:&#x2F;var&#x2F;www&#x2F;html&#x2F;myproject&#x2F;media #以数据卷挂载容器内用户上传媒体文件</span><br><span class="line">    - .&#x2F;compose&#x2F;uwsgi: &#x2F;tmp # 挂载uwsgi日志</span><br><span class="line">  networks:</span><br><span class="line">    - nginx_network</span><br><span class="line">    - db_network</span><br><span class="line">    - redis_network</span><br><span class="line">  depends_on:</span><br><span class="line">    - db</span><br><span class="line">    - redis</span><br><span class="line">  restart: always</span><br><span class="line">  tty: true</span><br><span class="line">  stdin_open: true</span><br><span class="line"></span><br><span class="line">nginx:</span><br><span class="line">  build: .&#x2F;compose&#x2F;nginx</span><br><span class="line">  ports:</span><br><span class="line">    - &quot;80:80&quot;</span><br><span class="line">    - &quot;443:443&quot;</span><br><span class="line">  expose:</span><br><span class="line">    - &quot;80&quot;</span><br><span class="line">  volumes:</span><br><span class="line">    - .&#x2F;compose&#x2F;nginx&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;nginx.conf # 挂载nginx配置文件</span><br><span class="line">    - .&#x2F;compose&#x2F;nginx&#x2F;ssl:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;ssl # 挂载ssl证书目录</span><br><span class="line">    - .&#x2F;compose&#x2F;nginx&#x2F;log:&#x2F;var&#x2F;log&#x2F;nginx # 挂载日志</span><br><span class="line">    - static_vol:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;static # 挂载静态文件</span><br><span class="line">    - media_vol:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;media # 挂载用户上传媒体文件</span><br><span class="line">  networks:</span><br><span class="line">    - nginx_network</span><br><span class="line">  depends_on:</span><br><span class="line">    - web</span><br><span class="line">  restart:always</span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<h4 id="3-2-编写Web-Django-Uwsgi-镜像和容器所需文件"><a href="#3-2-编写Web-Django-Uwsgi-镜像和容器所需文件" class="headerlink" title="3.2 编写Web(Django+Uwsgi)镜像和容器所需文件"></a>3.2 编写Web(Django+Uwsgi)镜像和容器所需文件</h4><p>构建Web镜像(Django+Uwsgi)的所使用的Dockerfile如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 建立 python 3.9环境</span><br><span class="line">FROM python:3.9</span><br><span class="line"></span><br><span class="line"># 安装netcat</span><br><span class="line">RUN apt-get update &amp;&amp; apt install -y netcat</span><br><span class="line"></span><br><span class="line"># 镜像作者</span><br><span class="line">MAINTAINER lzx</span><br><span class="line"></span><br><span class="line"># 设置python环境变量</span><br><span class="line">ENV PYTHONDONTWRITEBYTECODE 1</span><br><span class="line">ENV PYTHONUNBUFFERD 1</span><br><span class="line"></span><br><span class="line"># 可选: 设置镜像源为国内</span><br><span class="line">COPY pip.conf &#x2F;root&#x2F;.pip&#x2F;pip.conf</span><br><span class="line"></span><br><span class="line"># 容器内创建myproject文件夹</span><br><span class="line">ENV APP_HOME&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;myproject</span><br><span class="line">RUN mkdir -p $APP_HOME</span><br><span class="line">WORKDIR $APP_HOME</span><br><span class="line"></span><br><span class="line"># 将当前目录加入到工作目录中</span><br><span class="line">ADD . $APP_HOME</span><br><span class="line"></span><br><span class="line"># 更新pip版本</span><br><span class="line">RUN &#x2F;usr&#x2F;local&#x2F;bin&#x2F;python -m pip install --upgrade pip</span><br><span class="line"></span><br><span class="line"># 安装项目依赖</span><br><span class="line">RUN pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"># 移除\r in windows</span><br><span class="line">RUN sed -i &#39;s&#x2F;\r&#x2F;&#x2F;&#39; .&#x2F;start.sh</span><br><span class="line"></span><br><span class="line"># 给start.sh可执行权限</span><br><span class="line">RUN chmod +x .&#x2F;start.sh</span><br><span class="line"></span><br><span class="line"># 数据迁移，并使用uwsgi启动服务</span><br><span class="line">ENTRYPOINT &#x2F;bin&#x2F;bash .&#x2F;start.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># 从第一行到最后一行分别表示：</span><br><span class="line"># 1.等待MySQL服务启动后再进行数据迁移，nc即netcat缩写</span><br><span class="line"># 2.收集静态文件到根目录static文件夹</span><br><span class="line"># 3.生成数据库可执行文件</span><br><span class="line"># 4.根据数据库可执行文件来修改数据库</span><br><span class="line"># 5.用uwsgi启动django服务</span><br><span class="line"># 6.tail空命令防止web容器执行脚本后退出</span><br><span class="line">while ! nc -z db 3306 ;do</span><br><span class="line">    echo &quot;Waiting for the MySQL Server&quot;</span><br><span class="line">    sleep 3</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">python manage.py collectstatic --noinput &amp;&amp;</span><br><span class="line">python manage.py makemigrations&amp;&amp;</span><br><span class="line">python manage.py migrate&amp;&amp;</span><br><span class="line">uwsgi --ini &#x2F;var&#x2F;www&#x2F;html&#x2F;myproject&#x2F;uwsgi.ini&amp;&amp;</span><br><span class="line">tail -f &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">exec &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line">[uwsgi]</span><br><span class="line"></span><br><span class="line">project&#x3D;myproject</span><br><span class="line">uid&#x3D;www-data</span><br><span class="line">gid&#x3D;www-data</span><br><span class="line">base&#x3D;&#x2F;var&#x2F;www&#x2F;html</span><br><span class="line"></span><br><span class="line">chdir&#x3D;%(base)&#x2F;%(project)</span><br><span class="line">module&#x3D;%(project).wsgi:application</span><br><span class="line">master&#x3D;True</span><br><span class="line">processes&#x3D;2</span><br><span class="line"></span><br><span class="line">socket&#x3D;0.0.0.0:8000</span><br><span class="line">chown-socket&#x3D;%(uid):www-data</span><br><span class="line">chmod-socket&#x3D;664</span><br><span class="line"></span><br><span class="line">vacuum&#x3D;True</span><br><span class="line">max-requests&#x3D;5000</span><br><span class="line"></span><br><span class="line">pidfile&#x3D;&#x2F;tmp&#x2F;%(project)-master.pid</span><br><span class="line">daemonize&#x3D;&#x2F;tmp&#x2F;%(project)-uwsgi.log</span><br><span class="line"></span><br><span class="line"># 设置一个请求的超时时间，如果一个请求超过了这个时间，则请求被丢弃</span><br><span class="line">harakiri &#x3D; 60</span><br><span class="line">post buffering &#x3D; 8192</span><br><span class="line">buffer-size &#x3D; 65535</span><br><span class="line"># 当一个请求被harakiri杀掉时，会输出一条日志</span><br><span class="line">harakiri-verbose &#x3D; true</span><br><span class="line"></span><br><span class="line"># 开启内存使用情况报告</span><br><span class="line">memory-report &#x3D; true</span><br><span class="line"></span><br><span class="line"># 设置平滑的重启(直到处理完接收到的请求)的长等待时间</span><br><span class="line">reload-merccy &#x3D; 10</span><br><span class="line"></span><br><span class="line"># 设置工作进度使用虚拟内存超过N MB就回收重启</span><br><span class="line">reload-on-as&#x3D;1024</span><br></pre></td></tr></table></figure>
<h4 id="3-3-编写Nginx镜像和容器所需文件"><a href="#3-3-编写Nginx镜像和容器所需文件" class="headerlink" title="3.3 编写Nginx镜像和容器所需文件"></a>3.3 编写Nginx镜像和容器所需文件</h4><p>构建Nginx镜像所需的Dockerfile如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># nginx镜像compose&#x2F;nginx&#x2F;Dockerfile</span><br><span class="line"></span><br><span class="line">FROM nginx:latest</span><br><span class="line"></span><br><span class="line"># 删除原有配置文件，创建静态资源文件和ssl证书保存文件夹</span><br><span class="line">RUN rm &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf \</span><br><span class="line">&amp;&amp; mkdir -p &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;static \</span><br><span class="line">&amp;&amp; mkdir -p &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;media \</span><br><span class="line">&amp;&amp; mkdir -p &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;ssl</span><br><span class="line"></span><br><span class="line"># 设置media文件夹用户和用户组为Linux默认www-data，并给予可读和可执行权限</span><br><span class="line"># 否则用户上传的图片无法正常显示</span><br><span class="line">RUN chown -R www-data:www-data &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;media \</span><br><span class="line">&amp;&amp; chmod -R 775 &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;media</span><br><span class="line"></span><br><span class="line"># 添加配置文件</span><br><span class="line">ADD .&#x2F;nginx.conf &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;</span><br><span class="line"></span><br><span class="line"># 关闭守护模式</span><br><span class="line">CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span><br></pre></td></tr></table></figure>
<p>Nginx的配置文件如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># nginx配置文件</span><br><span class="line"># compose&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">upstream django&#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server web:8000; # Docker-compose web服务端口</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 配置http请求，80端口</span><br><span class="line">server&#123;</span><br><span class="line">    listen 80; # 监听80端口</span><br><span class="line">    server_name 127.0.0.1; # 可以是Nginx容器所在ip地址或127.0.0.1，不能写宿主机外网ip地址</span><br><span class="line">    </span><br><span class="line">    charset utf-8;</span><br><span class="line">    client_max_body_size 10M; # 限制用户上传文件大小</span><br><span class="line">    </span><br><span class="line">    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access_log main;</span><br><span class="line">    error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">    </span><br><span class="line">    location &#x2F;static&#123;</span><br><span class="line">        alias &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;static; # 静态资源路径</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location &#x2F;media&#123;</span><br><span class="line">        alias &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;media; # 媒体资源，用户上传文件路径</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        include &#x2F;etc&#x2F;nginx&#x2F;uwsgi_params;</span><br><span class="line">        uwsgi_pass django;</span><br><span class="line">        uwsgi_read_timeout 600;</span><br><span class="line">        uwsgi_connect_timeout 600;</span><br><span class="line">        uwsgi_send_timeout 600;</span><br><span class="line">        </span><br><span class="line">        proxy_set_header X-Formwarded-For &amp;proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        # proxy_pass http:&#x2F;&#x2F;django; # 使用uwsgi通信，而不是http，所以不使用proxy_pass</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-编写Db-MySQL-容器配置文件"><a href="#3-4-编写Db-MySQL-容器配置文件" class="headerlink" title="3.4 编写Db(MySQL)容器配置文件"></a>3.4 编写Db(MySQL)容器配置文件</h4><p>启动MySQL容器我们直接使用官方镜像即可，不过我们需要给MySQL增加配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># compose&#x2F;mysql&#x2F;conf&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">user&#x3D;mysql</span><br><span class="line">default-storage-engine&#x3D;INNODB</span><br><span class="line">character-set-server&#x3D;utf8</span><br><span class="line">secure-file-priv&#x3D;NULL</span><br><span class="line">default-authentication-plugin&#x3D;mysql_native_password</span><br><span class="line"></span><br><span class="line">port &#x3D; 3306 # 端口与docker-compose里映射端口保持一致</span><br><span class="line">#bind-address&#x3D;localhost # 一定要注释掉，mysql所在容器和Django所在容器不同ip</span><br><span class="line"></span><br><span class="line">basedir &#x3D;&#x2F;usr</span><br><span class="line">datadir &#x3D;&#x2F;var&#x2F;lib&#x2F;mysql</span><br><span class="line">tmpdir &#x3D; &#x2F;tmp</span><br><span class="line">pid-file &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid</span><br><span class="line">socket &#x3D; &#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.sock</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port&#x3D;3306</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们还需要设置MySQL服务启动时需要执行的脚本命令，注意这里的用户名和password必须和myproject目录下<code>.env</code>文件中的环境变量保持一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># compose&#x2F;mysql&#x2F;init&#x2F;init.sql</span><br><span class="line">Alter user &#39;dbuser&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;password&#39;;</span><br><span class="line">GRANT ALL PRIVILEGES ON myproject.* TO &#39;dbuser&#39;@&#39;%&#39;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;</span><br><span class="line">MYSQL_ROOT_PASSWORD&#x3D;123456</span><br><span class="line">MYSQL_USER&#x3D;dbuser</span><br><span class="line">MYSQL_DATABASE&#x3D;myproject</span><br><span class="line">MYSQL_PASSWORD&#x3D;password</span><br></pre></td></tr></table></figure>
<h4 id="3-5-编写Redis容器配置文件"><a href="#3-5-编写Redis容器配置文件" class="headerlink" title="3.5 编写Redis容器配置文件"></a>3.5 编写Redis容器配置文件</h4><p>启动redis容器我们直接使用官方镜像即可，不过我们需要给redis增加配置文件，大部分情况下采用默认配置就好了，这里我们只做出了如下几条核心改动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># compose&#x2F;redis&#x2F;redis.conf</span><br><span class="line"># Redis 5 配置文件下载地址</span><br><span class="line"></span><br><span class="line"># 请注释掉下面一行，这样其他机器或容器也可访问</span><br><span class="line">bind 127.0.0.1</span><br><span class="line"></span><br><span class="line"># 取消下行注释，给redis设置登录密码，这个密码django settings.py会用到</span><br><span class="line">requirepass yourpassword</span><br></pre></td></tr></table></figure>
<h4 id="3-6-修改Django项目settings-py"><a href="#3-6-修改Django项目settings-py" class="headerlink" title="3.6 修改Django项目settings.py"></a>3.6 修改Django项目settings.py</h4><p>在我们准备好docker-compose.yml并编排好各容器的Dockerfile及配置文件后，不要急于使用Docker-compose命令构建镜像和启动容器。此时要先修改Django的<code>settings.py</code>，提供Mysql和redis服务的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 生产环境设置Debug&#x3D;False</span><br><span class="line">Debug &#x3D; False</span><br><span class="line"></span><br><span class="line"># 设置ALLOWED HOSTS</span><br><span class="line">ALLOWED_HOSTS &#x3D; [&#39;your_server_IP&#39;, &#39;your_domain_name&#39;]</span><br><span class="line"></span><br><span class="line"># 设置STATIC ROOT和STATIC URL</span><br><span class="line">STATIC_ROOT &#x3D; os.path.join(BASE_DIR, &#39;static&#39;)</span><br><span class="line">STATIC_URL &#x3D; &quot;&#x2F;media&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"># 设置数据库，这里用户名和密码必须和docker-compose.yml里mysql环境变量保持一致</span><br><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;:&#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.bakends.mysql&#39;,</span><br><span class="line">        &#39;NAME&#39;: &#39;myproject&#39;, # 数据库名</span><br><span class="line">        &#39;USER&#39;: &#39;dbuser&#39;, # 你设置的用户名</span><br><span class="line">        &#39;PASSWORD&#39;: &#39;password&#39;,</span><br><span class="line">        &#39;HOST&#39;: &#39;db&#39;,</span><br><span class="line">        &#39;PORT&#39;: &#39;3306&#39;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置redis缓存，这里密码为redis.conf里设置的密码</span><br><span class="line">CACHES &#x3D; &#123;</span><br><span class="line">    &quot;default&quot;:&#123;</span><br><span class="line">        &quot;BACKEND&quot;: &quot;django_redis.cache.RedisCache&quot;,</span><br><span class="line">        &quot;LOCATION&quot;: &quot;redis:&#x2F;&#x2F;redis:6379&#x2F;1&quot;,</span><br><span class="line">        &quot;OPTIONS&quot;:&#123;</span><br><span class="line">            &quot;CLIENT_CLASS&quot;: &quot;django_redis.client.DefaultCient&quot;,</span><br><span class="line">            &quot;PASSWORD&quot;: &quot;yourpassword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-7-使用docker-compose构建镜像并启动容器组服务"><a href="#3-7-使用docker-compose构建镜像并启动容器组服务" class="headerlink" title="3.7 使用docker-compose构建镜像并启动容器组服务"></a>3.7 使用docker-compose构建镜像并启动容器组服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 进入docker-compose.yml所在文件夹，输入以下命令构建镜像</span><br><span class="line">sudo docker-compose build</span><br><span class="line"># 查看已生成的镜像</span><br><span class="line">sudo docker images</span><br><span class="line"># 启动容器组服务</span><br><span class="line">sudo docker-compose up</span><br></pre></td></tr></table></figure>
<h4 id="3-8-排错"><a href="#3-8-排错" class="headerlink" title="3.8 排错"></a>3.8 排错</h4><h5 id="Nginx容器排错"><a href="#Nginx容器排错" class="headerlink" title="Nginx容器排错"></a>Nginx容器排错</h5><p>容器已经启动运行，网站打不开，最有用的是查看Nginx的错误日志error.log，由于我们对Nginx的log进行了挂载，你可以在宿主机的/compose/nginx/log目录里直接查看相关日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 进入nginx日志目录，一个access.log,一个error.log</span><br><span class="line">cd compose&#x2F;nginx&#x2F;log</span><br><span class="line">cat error.log</span><br></pre></td></tr></table></figure>
<p>绝大部分网站打不开，Nginx日志显示<code>nginx:connect() failed(111:Connection refused) while connecting to upstream</code>或Nginx 502 gateway的错误都不是因为nginx自身的原因导致的，而是Web容器中Django程序有问题或者uwsgi配置文件有问题。</br><br>在进入Web容器排错前，你首先要检查下Nginx转发请求的方式(proxy_pass和uwsgi_pass)以及转发端口与uwsgi的监听方式以及端口是否一致。</br><br>uWSGI和Nginx之间有3种通信方式：unix socket, TCP socket和http，如果Nginx以proxy_pass方式转发请求，uwsgi需要使用http协议进行通信。如果Nginx以<code>uwsgi_pass</code>转发请求，uwsgi建议配置socket进行通信</p>
<h5 id="Web容器排错"><a href="#Web容器排错" class="headerlink" title="Web容器排错"></a>Web容器排错</h5><p>Web容器也就是Django+UWSGI所在的容器。如果Nginx配置没问题，应该进入web容器查看运行脚本命令时有没有报错，并检查uwsgi的运行日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看web容器的日志</span><br><span class="line">dicker-compose logs web</span><br><span class="line"># 进入web容器执行启动命令，查看有无报错</span><br><span class="line">docker-compose exec web &#x2F;bin&#x2F;bash start.sh</span><br><span class="line"># 或者进入web容器内</span><br><span class="line">docker-compose exec web &#x2F;bin&#x2F;bash</span><br><span class="line"># 进入web容器，查看uwsgi是否正常启动</span><br><span class="line">ps aux | grep uwsgi</span><br><span class="line"># 进入uwsgi日志所在目录，查看Django项目是否有报错</span><br><span class="line">cd &#x2F;tmp</span><br></pre></td></tr></table></figure>
<p>有时web容器会出现不能连接到数据库的报错，这时需要检查<code>settings.py</code>中的数据库配置信息是否正确，并检查web容器和db容器是否通过<code>db_network</code>正常通信</p>
<h5 id="数据库db容器排错"><a href="#数据库db容器排错" class="headerlink" title="数据库db容器排错"></a>数据库db容器排错</h5><p>我们还需要经常进入数据库容器查看数据表是否已生成并删除一些数据，这时可以使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 进入db容器</span><br><span class="line">docker-compose exec db &#x2F;bin&#x2F;bash</span><br><span class="line"># 登录</span><br><span class="line">mysql -u username -p;</span><br><span class="line"># 选择数据库</span><br><span class="line">USE dbname;</span><br><span class="line"># 显示数据库</span><br><span class="line">SHOW tables;</span><br><span class="line"># 清空数据表</span><br><span class="line">DELETE from tablename;</span><br><span class="line"># 删除数据表</span><br><span class="line">DROP TABLE tablename;</span><br></pre></td></tr></table></figure>
<h2 id="四-Django性能优化大全"><a href="#四-Django性能优化大全" class="headerlink" title="四.Django性能优化大全"></a>四.Django性能优化大全</h2><p>&emsp;&emsp;如果你的Python程序或Django项目运行速度慢，先别急着怪Django。其实程序运行效率是可以通过提升硬件水平、架构和数据库优化和改进算法来大大提升的。这部分将列举一些主要的Django性能优化手段，完全可以让你的Django程序跑的飞快。</br><br>&emsp;&emsp;过度性能优化是没有必要甚至是有害的。因为花大力气带来的毫秒级的响应提升你的用户可能根本感知不到，毕竟开发人员的时间也很宝贵。</p>
<h3 id="1-性能优化指标"><a href="#1-性能优化指标" class="headerlink" title="1.性能优化指标"></a>1.性能优化指标</h3><p>在对一个Web项目进行性能优化时，我们通常需要考虑如下几个指标：</p>
<ul>
<li>响应时间</li>
<li>最大并发连接数</li>
<li>代码的行数</li>
<li>函数调用次数</li>
<li>内存占用情况</li>
<li>CPU占比</li>
</ul>
<p>&emsp;&emsp;其中响应时间(服务器从接收用户请求、处理该请求并返回结果所需的总时间)通常是最重要的性能指标，因为过长的响应时间会让用户厌倦等待，转投其他网站或APP。当你的用户数量变得非常庞大，如何提高最大并发连接数，减少内存消耗也将变得非常重要。</br><br>&emsp;&emsp;在开发环境中，我们一般建议使用<code>django-debug-toolbar</code>和<code>django-silk</code>来进行性能监测分析。它们提供了每次用户请求的响应时间，并告诉你程序执行过程哪个环节(比如SQL查询)最消耗时间。</br><br>&emsp;&emsp;对于中大型网站或Web APP而言，最影响网站性能的就是数据库查询部分了。一是反复从数据库读写数据很消耗时间和计算资源。二是当返回的查询数据集queryset非常大时还会占据很多内存。我们先从这部分优化做起。</p>
<h3 id="2-数据库查询优化"><a href="#2-数据库查询优化" class="headerlink" title="2.数据库查询优化"></a>2.数据库查询优化</h3><h4 id="利用Queryset的惰性和缓存，避免重复查询"><a href="#利用Queryset的惰性和缓存，避免重复查询" class="headerlink" title="利用Queryset的惰性和缓存，避免重复查询"></a>利用Queryset的惰性和缓存，避免重复查询</h4><p>充分利用Django的QuerySet的惰性和自带缓存特性，可以帮助我们减少数据库查询次数。比如下例中例1要比例2好。因为你在打印文章标题后，Django不仅执行了数据库查询，还把查询到的<code>article_list</code>放在了缓存里，下次可以在其他地方复用，而例2就不行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 例1-利用了缓存特性</span><br><span class="line">article_list &#x3D; Article.objects.filter(title_contain&#x3D;&quot;django&quot;)</span><br><span class="line">for article in article_list:</span><br><span class="line">    print(article.title)</span><br><span class="line">    </span><br><span class="line"># 例2</span><br><span class="line">for article in Article.objects.filter(title_contains&#x3D;&quot;django&quot;):</span><br><span class="line">    print(article.title)</span><br></pre></td></tr></table></figure>
<p>但有时我们只希望了解查询的结果是否存在或查询结果的数量，这时可以使用<code>exists()</code>和<code>count()</code>方法，如下所示。这样做就不会浪费资源查询一个用不到的数据集，还可以节省内存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 例3：</span><br><span class="line">article_list &#x3D; Article.objects.filter(title_contains&#x3D;&quot;django&quot;)</span><br><span class="line">if article_list.exists():</span><br><span class="line">    print(&quot;Records found.&quot;)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;No records&quot;)</span><br><span class="line">    </span><br><span class="line"># 例4：</span><br><span class="line">count &#x3D; Article.objects.filter(title_contains&#x3D;&quot;django&quot;).count()</span><br></pre></td></tr></table></figure>
<h4 id="一次查询所有需要的关联模型数据"><a href="#一次查询所有需要的关联模型数据" class="headerlink" title="一次查询所有需要的关联模型数据"></a>一次查询所有需要的关联模型数据</h4><p>假设我们有一个文章(Article)模型，其与类别(Category)是单对多的关系(ForeignKey)，与标签(Tag)是多对多的关系(ManyToMany)。我们需要编写一个<code>article_list</code>的函数视图，以列表形式显示文章清单及每篇文章的类型和标签，你的模板文件可能如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">&#123;% for article in articles %&#125;</span><br><span class="line">    &lt;li&gt;&#123;&#123; article.title&#125;&#125; &lt;&#x2F;li&gt;</span><br><span class="line">    &lt;li&gt;&#123;&#123; article.category.name &#125;&#125; &lt;&#x2F;li&gt;</span><br><span class="line">    &lt;li&gt;</span><br><span class="line">        &#123;% for tag in article.tags.all%&#125;</span><br><span class="line">            &#123;&#123; tag.name &#125;&#125;,</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure>
<p>在模板里每进行一次for循环获取关联对象category和tag的信息，Django就要单独进行一次数据库查询，造成了极大资源浪费。我们完全可以使用<code>select_related</code>方法和<code>prefetch_related</code>方法一次性从数据库获取单对多和多对多关联模型数据，这样在模板中遍历时Django也不会执行数据库查询了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 仅获取文章数据 -Bad</span><br><span class="line">def article_list(request):</span><br><span class="line">    articles &#x3D; Article.objects.all()</span><br><span class="line">    return render(request, &#39;blog&#x2F;article_list.html&#39;, &#123;&#39;articles&#39;: articles,&#125;)</span><br><span class="line"></span><br><span class="line"># 一次性提取关联模型数据 -Good</span><br><span class="line">def article_list(request):</span><br><span class="line">    articles &#x3D; Article.objects.all().select_related(&#39;category&#39;).prefecth_related(&#39;tags&#39;)</span><br><span class="line">    return render(request, &#39;blog&#x2F;article_list.html&#39;, &#123;&#39;articles&#39;: article,&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="仅查询需要用到的数据"><a href="#仅查询需要用到的数据" class="headerlink" title="仅查询需要用到的数据"></a>仅查询需要用到的数据</h4><p>&emsp;&emsp;默认情况下Django会从数据库中提取所有字段，但是当数据表有很多列很多行的时候，告诉Django提取哪些特定的字段就非常有意义了。假如我们的数据库中有100万篇文章，需要循环打印每篇文章的标题。如果按例4操作，我们会将每篇文章对象的全部信息都提取出来载入到内存中，不仅花费更多时间查询，还会占用大量内存，而最后只用了一个title字段，这是完全没有必要的。我们可以使用<code>values</code>和<code>value_list</code>方法按需提取数据，比如只获取文章的id和title，节省查询时间和查询内存。</p>
<h4 id="使用分页，限制最大页数"><a href="#使用分页，限制最大页数" class="headerlink" title="使用分页，限制最大页数"></a>使用分页，限制最大页数</h4><p>上面的方法可以做进一步的优化，比如使用分页仅展示用户所需要的数据，而不是一下子展示所有数据。同时使用分页时也最好控制最大页数，比如当你的数据库有100万篇文章时，每页即使展示100页，也需要1万页展示给你的用户，这是完全没有必要的。你可以完全只展示前200页的数据，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LIMIT &#x3D; 100 * 200</span><br><span class="line"></span><br><span class="line">data &#x3D; Articles.objects().all()[:(LIMIT+1)]</span><br><span class="line">if len(data) &gt; LIMIT:</span><br><span class="line">    raise ExceededLimit(LIMIT)</span><br><span class="line">    </span><br><span class="line">return data</span><br></pre></td></tr></table></figure>
<h4 id="数据库设置优化"><a href="#数据库设置优化" class="headerlink" title="数据库设置优化"></a>数据库设置优化</h4><p>如果你使用单个数据库，你可以采用如下手段进行优化：</p>
<ul>
<li>建立模型时能用<code>CharField</code>确定长度的字段尽量不用<code>TextField</code>，可节省存储空间。</li>
<li>可以给搜索频率高的字段属性，在定义模型时使用索引(<code>db_index=True</code>)</li>
<li>持久化数据库连接</li>
</ul>
<blockquote>
<p>The document says that using <code>db_index=True</code> on model fields is used to speed up the lookups with slightly disadvantages with storages and memory</p>
</blockquote>
<p>没有持久化连接，Django每个请求都会与数据库创建一个连接，直到请求结束，关闭连接。如果数据库不在本地，每次建立和关闭连接也需要花费一些时间。设置持久化连接时间，仅需要添加<code>CONN_MAX_AGE</code>参数到你的数据库设置中，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;:&#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.backends.postgresql_psycopg2&#39;,</span><br><span class="line">        &#39;NAME&#39;: &#39;postgres&#39;,</span><br><span class="line">        &#39;CONN_MAX_AGE&#39;: 60,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然CONN_MAX_AGE也不宜设置过大，因为每个数据库并发连接数有上限，比如mysql默认的最大并发连接数是100个。如果CONN_MAX_AGE设置的过大，会导致mysql数据库连接数飙升很快达到上限。当并发请求数量很高时，CONN_MAX_AGE应该设低点；当并发请求数不高时，这个值可以设置的长一点。</br><br>当用户非常多，数据量非常大时，你可以考虑读写分离、主从复制、分表分库的多数据库服务器架构。这种架构上的布局是对所有Web开发语言适用的。</p>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>缓存是一类可以更快的读取数据的介质统称，也指其它可以加快数据读取的存储方式。一般用来存储临时数据，常用介质是读取速度很快的内存。一般来说从数据库多词把所需要的数据提取出来，要比从内存或者硬盘等一次读出来付出的成本大很多。对于中大型网站而言，使用缓存减少对数据库的访问次数是提升网站性能的关键之一。</p>
<h5 id="视图缓存"><a href="#视图缓存" class="headerlink" title="视图缓存"></a>视图缓存</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from django.views.decorators.cache import cache_page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@cache_page(60*15)</span><br><span class="line">def my_view(request):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h5 id="使用-cached-property装饰器缓存计算属性"><a href="#使用-cached-property装饰器缓存计算属性" class="headerlink" title="使用@cached_property装饰器缓存计算属性"></a>使用@cached_property装饰器缓存计算属性</h5><p>对于不经常变动的计算属性，可以使用<code>@cached_property</code>装饰器缓存结果。</p>
<h5 id="缓存临时性数据比如sessions"><a href="#缓存临时性数据比如sessions" class="headerlink" title="缓存临时性数据比如sessions"></a>缓存临时性数据比如sessions</h5><p>Django的session默认是存在数据库中的，这样的话每一个请求Django都要使用sql查询会话数据，然后获得用户对象的信息，对于临时性的数据比如sessions和messages，最好将它们放在缓存中，也可以减少SQL查询次数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SESSION_ENGINE &#x3D; &#39;django.contrib.sessions.backends.cache&#39;</span><br></pre></td></tr></table></figure>
<h5 id="模板缓存"><a href="#模板缓存" class="headerlink" title="模板缓存"></a>模板缓存</h5><p>默认情况下Django每处理一个请求都会使用模板加载器，都会去文件系统里搜索模板，然后渲染这些模板。你可以通过使用<code>cached.loader</code>开启模板缓存加载。这时Django只会查找并且解析你的模板一次，可以大大提升模板渲染效率。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES &#x3D; [&#123;</span><br><span class="line">    &#39;BACKEND&#39;: &#39;django.template.backends.django.DjangoTemplates&#39;,</span><br><span class="line">    &#39;DIRS&#39;: [BASE_DIR &#x2F; &#39;templates&#39;],</span><br><span class="line">    &#39;OPTIONS&#39;:&#123;</span><br><span class="line">        &#39;loaders&#39;:[</span><br><span class="line">        &#123;</span><br><span class="line">            &#39;django.template.loaders.cached.Loader&#39;,[</span><br><span class="line">            &#39;django.template.loaders.filesystem.Loader&#39;,</span><br><span class="line">            &#39;django.template.loaders.app_directories.Loader&#39;,</span><br><span class="line">            &#39;path.to.custom.Loader&#39;,</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>另外模板文件中建议使用with标签缓存视图传来的数据，便于下一次时使用，对于公用的html片段，也建议使用缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load cache %&#125;</span><br><span class="line">&#123;% cache 500 sidebar request.user.username %&#125;</span><br><span class="line">  .. sidebar for loggerd in user ..</span><br><span class="line">&#123;% cache % &#125;</span><br></pre></td></tr></table></figure>
<h3 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h3><p>压缩HTML、CSS和JavaScript等静态文件可以节省带宽和传输时间。Django自带的压缩工具有GzipMiddleware中间件和spaceless模板Tag。使用Python压缩静态文件会影响性能，一个更好的方法是通过Apache、Nginx服务器来对输出内容进行压缩。例如Nginx服务器支持gzip压缩，同时可以设置expires选项设置静态文件的缓存时间。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://twilight2017.github.io/2022/12/07/Django%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%EF%BC%9A%E4%B8%89/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Django/" rel="tag">Django</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8A%80%E6%9C%AF/" rel="tag">技术</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/01/30/Python%E6%A8%A1%E5%9D%97%E5%AD%A6%E4%B9%A0%E4%B9%8Btimeit/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Python模块学习之timeit
          
        </div>
      </a>
    
    
      <a href="/2022/11/21/Django%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8%EF%BC%9A%E4%B8%80/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Django高级使用：一</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "",
    app_key: "",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2023
        <i class="ri-heart-fill heart_icon"></i> twilight2017
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        由 <a href="https://hexo.io" target="_blank">Hexo</a> 强力驱动
        <span class="division">|</span>
        主题 - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="瑟兰迪尔"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E6%8A%80%E6%9C%AF">技术</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E8%AF%BB%E4%B9%A6">读书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/travels">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/%E9%9A%8F%E7%AC%94">随笔</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


    
  </div>
</body>

</html>